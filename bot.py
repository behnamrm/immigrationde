import os
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes, MessageHandler, filters

# ✅ Main menu (right-to-left)
MAIN_MENU = [
    ["❓ سوالات پرتکرار", "📝 چک‌لیست مهاجرت"],
    ["🔗 گروه‌های پرسش و پاسخ", "💼 خدمات مهاجرتی"],
    ["📬 تماس با ما"]
]

# ✅ Checklist submenu
CHECKLIST_MENU = [
    ["1. ℹ️ کسب اطلاعات کلی", "2. 📄 مدارک مورد نیاز پذیرش"],
    ["3. 📬 مراحل اخذ پذیرش", "4. 🛂 آمادگی برای سفارت"],
    ["5. ✈️ ورود به آلمان", "📋 مشاهده همه مراحل"],
    ["🔙 بازگشت به منوی اصلی"]
]

# ✅ Subitems for each checklist category
CHECKLIST_SUBITEMS = {
    "1. ℹ️ کسب اطلاعات کلی": [
        "🇩🇪 چرا کشور آلمان؟", "🎓 انواع مقاطع تحصیلی در آلمان", "🗣️ تحصیل به آلمانی یا انگلیسی؟",
        "📄 پذیرش مشروط یا مستقیم؟", "📝 انواع آزمون های زبان آلمانی", "📬 چطور پذیرش بگیریم؟",
        "🎓 بورسیه تحصیلی", "💰 هزینه های زندگی در آلمان", "👨‍💼 کار دانشجویی در آلمان",
        "📊 تبدیل معدل ایران به آلمانی", "💼 بازار کار و درآمد رشته های مختلف در آلمان",
        "🪖 قوانین مشمولان سربازی", "👨‍👩‍👧‍👦 ویزای پیوست به همسر و خانواده"
    ],
    "2. 📄 مدارک مورد نیاز پذیرش": [
        "🗣️ اخذ مدرک زبان", "📝 ترجمه مدارک", "💡 ساخت انگیزه نامه", "📄 ساخت روزمه",
        "🎨 ساخت پورتفولیو", "📨 توصیه نامه از اساتید", "🧾 گواهی سایقه کار",
        "✅ تایید (لگال/بگلا) مدارک ترجمه شده در سفارت"
    ],
    "3. 📬 مراحل اخذ پذیرش": [
        "🏫 دانشگاه یا هوخشوله؟", "📊 رنکینگ دانشگاه های آلمان", "📅 ددلاین پذیرش",
        "🔍 سایت های جستجوی دانشگاه و رشته", "🌐 پذیرش از طریق سایت یونی اسیست",
        "📘 سایت آنابین", "📥 اخذ پذیرش از دانشگاه", "📦 ارسال مدارک به صورت پستی",
        "📝 ثبت نام نهایی در دانشگاه", "🛡️ بیمه دانشجویی", "🏠 گرفتن خوابگاه دانشجویی"
    ],
    "4. 🛂 آمادگی برای سفارت": [
        "📅 گرفتن نوبت سفارت", "📋 چک لیست مدارک روز مصاحبه", "❓ سوالات متداول روز مصاحبه",
        "🗣️ مصاحبه و تحویل ویزا", "⛔ دلایل معمول ریجکتی"
    ],
    "5. ✈️ ورود به آلمان": [
        "🎫 خرید بلیط هواپیما", "🎒 چه وسایلی با خودم ببرم؟", "🛬 فرودگاه و فرم زول",
        "🏠 پیدا کردن خوابگاه و خانه", "📱 خرید سیم کارت در آلمان", "🏢 ثبت محل سکونت (ملده کردن)",
        "🏦 باز کردن حساب بانکی", "🪪 گرفتن کارت اقامت", "🔁 تمدید اقامت بعد از یکسال"
    ]
}


# ✅ توضیحات کامل برای همه زیرآیتم‌ها
CHECKLIST_CONTENTS = {
    # 🔹 دسته 1: کسب اطلاعات کلی
    "🇩🇪 چرا کشور آلمان؟": "آلمان به دلیل دانشگاه‌های معتبر، شهریه پایین یا رایگان، فرصت‌های شغلی و اقامت پس از تحصیل یکی از محبوب‌ترین مقاصد دانشجویان ایرانی است.",
    "🎓 انواع مقاطع تحصیلی در آلمان": "مقاطع تحصیلی شامل کارشناسی (۳ سال)، کارشناسی ارشد (۱.۵-۲ سال) و دکترا (۳-۵ سال) است. برخی مقاطع نیازمند دوره کالج هستند.",
    "🗣️ تحصیل به آلمانی یا انگلیسی؟": "تحصیل در مقطع کارشناسی بیشتر به آلمانی است، در حالی که مقطع ارشد و دکترا گزینه‌های انگلیسی زیادی دارد.",
    "📄 پذیرش مشروط یا مستقیم؟": "پذیرش مشروط برای کسانی است که هنوز مدرک زبان ندارند و بعداً ارائه می‌دهند. پذیرش مستقیم به معنی ارسال کامل مدارک از جمله مدرک زبان است.",
    "📝 انواع آزمون های زبان آلمانی": "آزمون‌های معتبر شامل TestDaF، DSH، Goethe، telc هستند. حداقل سطح مورد قبول معمولاً B2 یا C1 است.",
    "📬 چطور پذیرش بگیریم؟": "ابتدا دانشگاه مناسب پیدا کنید، مدارک را تهیه و ترجمه کرده و از طریق یونی‌اسیست یا مستقیم به دانشگاه درخواست دهید.",
    "🎓 بورسیه تحصیلی": "بورسیه‌های آلمان بیشتر شامل هزینه زندگی می‌شوند (مثل DAAD). شهریه بیشتر دانشگاه‌ها رایگان است.",
    "💰 هزینه های زندگی در آلمان": "هزینه زندگی دانشجویی ماهانه حدود ۸۵۰ تا ۱۱۰۰ یورو است. شامل اجاره، خورد و خوراک، بیمه، حمل‌ونقل و غیره.",
    "👨‍💼 کار دانشجویی در آلمان": "دانشجویان می‌توانند سالانه ۱۲۰ روز کامل یا ۲۴۰ نیم‌روز کار کنند. درآمد ساعتی حدود ۱۲-۱۵ یورو است.",
    "📊 تبدیل معدل ایران به آلمانی": "معدل ایران به نمره آلمانی (۱ تا ۵) تبدیل می‌شود. سایت‌هایی مانند DAAD یا Uni-Assist ماشین حساب تبدیل دارند.",
    "💼 بازار کار و درآمد رشته های مختلف در آلمان": "رشته‌هایی مانند IT، مهندسی، پزشکی، پرستاری بازار کار بسیار خوبی دارند. درآمد ماهیانه از ۳۰۰۰ یورو شروع می‌شود.",
    "🪖 قوانین مشمولان سربازی": "مشمولان باید وضعیت خدمت وظیفه را مشخص کرده باشند (پایان خدمت، معافیت یا مجوز خروج).",
    "👨‍👩‍👧‍👦 ویزای پیوست به همسر و خانواده": "در صورت داشتن اقامت قانونی، امکان پیوست برای همسر و فرزند وجود دارد. نیازمند توان مالی و محل سکونت مناسب است.",

    # 🔹 دسته 2: مدارک مورد نیاز پذیرش
    "🗣️ اخذ مدرک زبان": "برای پذیرش، ارائه مدرک زبان آلمانی یا انگلیسی ضروری است (مثل TestDaF، DSH، IELTS، TOEFL).",
    "📝 ترجمه مدارک": "مدارک باید توسط دارالترجمه رسمی ترجمه شده و توسط دادگستری و وزارت خارجه تأیید شوند.",
    "💡 ساخت انگیزه نامه": "در انگیزه‌نامه باید دلایل انتخاب رشته و کشور، اهداف آینده و نقاط قوت خود را بیان کنید.",
    "📄 ساخت روزمه": "رزومه باید خلاصه‌ای از سوابق تحصیلی، کاری، مهارت‌ها و زبان‌ها باشد (فرمت Europass توصیه می‌شود).",
    "🎨 ساخت پورتفولیو": "برای رشته‌های هنری یا طراحی، نمونه‌کارها باید با توضیح کامل در قالب پورتفولیو ارائه شوند.",
    "📨 توصیه نامه از اساتید": "حداقل ۲ توصیه‌نامه از اساتید دانشگاه قبلی، با سربرگ رسمی و امضا الزامی است.",
    "🧾 گواهی سایقه کار": "برای رشته‌های حرفه‌ای، گواهی تجربه کاری با ذکر مدت، سمت و وظایف مفید است.",
    "✅ تایید (لگال/بگلا) مدارک ترجمه شده در سفارت": "برای ویزا، مدارک ترجمه‌شده باید در سفارت یا ویزامتریک تأیید (legalize) شوند.",

    # 🔹 دسته 3: مراحل اخذ پذیرش
    "🏫 دانشگاه یا هوخشوله؟": "Universität برای پژوهش‌محور و Hochschule برای کاربردی است. بسته به رشته، نوع مناسب را انتخاب کنید.",
    "📊 رنکینگ دانشگاه های آلمان": "رتبه دانشگاه‌ها را در سایت‌هایی مانند QS یا Times ببینید. برای ویزا، کیفیت و اعتبار دانشگاه مهم است.",
    "📅 ددلاین پذیرش": "ددلاین ترم تابستان معمولاً ژانویه و ترم زمستان ژوئن است. هر دانشگاه ددلاین خاص خود را دارد.",
    "🔍 سایت های جستجوی دانشگاه و رشته": "سایت‌هایی مثل DAAD.de، Hochschulkompass.de برای جستجوی برنامه‌های تحصیلی عالی هستند.",
    "🌐 پذیرش از طریق سایت یونی اسیست": "Uni-Assist یک پلتفرم مرکزی برای ارسال مدارک به چندین دانشگاه آلمانی است (با هزینه).",
    "📘 سایت آنابین": "سایت Anabin.de برای بررسی اعتبار دانشگاه یا مدرک ایرانی در آلمان استفاده می‌شود.",
    "📥 اخذ پذیرش از دانشگاه": "پس از ارسال مدارک و پرداخت هزینه، دانشگاه نتیجه را از طریق ایمیل اعلام می‌کند.",
    "📦 ارسال مدارک به صورت پستی": "برخی دانشگاه‌ها مدارک را به‌صورت پستی درخواست می‌کنند؛ حتماً از قبل بررسی کنید.",
    "📝 ثبت نام نهایی در دانشگاه": "پس از ورود، باید به صورت حضوری یا آنلاین در دانشگاه ثبت‌نام نهایی انجام دهید.",
    "🛡️ بیمه دانشجویی": "داشتن بیمه سلامت (قانونی یا خصوصی) برای ثبت‌نام و اقامت در آلمان الزامی است.",
    "🏠 گرفتن خوابگاه دانشجویی": "مراکز Studentenwerk یا وب‌سایت‌های اجاره اتاق دانشجویی برای درخواست خوابگاه مفید هستند.",

    # 🔹 دسته 4: آمادگی برای سفارت
    "📅 گرفتن نوبت سفارت": "برای ویزای دانشجویی، باید از طریق ویزامتریک یا سایت سفارت وقت رزرو کنید. ممکن است چند ماه طول بکشد.",
    "📋 چک لیست مدارک روز مصاحبه": "مدارک شامل پذیرش، بیمه، گواهی تمکن مالی، ترجمه‌ها و فرم‌های سفارت است.",
    "❓ سوالات متداول روز مصاحبه": "سوالاتی مانند هدف از تحصیل، برنامه آینده و هزینه‌های زندگی معمولاً پرسیده می‌شوند.",
    "🗣️ مصاحبه و تحویل ویزا": "مصاحبه در سفارت ساده ولی مهم است. صداقت و آمادگی ذهنی مهم‌اند.",
    "⛔ دلایل معمول ریجکتی": "ریجکتی ممکن است به دلایل نقص مدارک، تمکن ناکافی یا عدم اقناع افسر باشد.",

    # 🔹 دسته 5: ورود به آلمان
    "🎫 خرید بلیط هواپیما": "خرید بلیط پس از دریافت ویزا و هماهنگی با خوابگاه یا محل اقامت انجام می‌شود.",
    "🎒 چه وسایلی با خودم ببرم؟": "لباس، دارو، لپ‌تاپ، مدارک ضروری و شارژرهای چندگانه از وسایل پیشنهادی هستند.",
    "🛬 فرودگاه و فرم زول": "در بدو ورود به آلمان، ممکن است مأمور گمرک از شما فرم Zoll (فرم ورود) بخواهد.",
    "🏠 پیدا کردن خوابگاه و خانه": "در کنار خوابگاه، سایت‌هایی مانند WG-Gesucht.de یا ImmoScout24 برای اجاره خانه مفیدند.",
    "📱 خرید سیم کارت در آلمان": "اپراتورهای AldiTalk، O2 و Vodafone سیم‌کارت اعتباری با اینترنت مناسب ارائه می‌دهند.",
    "🏢 ثبت محل سکونت (ملده کردن)": "پس از ورود باید ظرف ۱۴ روز محل سکونت را در اداره Bürgeramt ثبت کنید.",
    "🏦 باز کردن حساب بانکی": "حساب بلاک‌شده برای دریافت ویزا الزامی است. پس از ورود هم حساب معمولی نیاز دارید.",
    "🪪 گرفتن کارت اقامت": "برای اقامت قانونی، باید وقت بگیرید و در Ausländerbehörde کارت اقامت دریافت کنید.",
    "🔁 تمدید اقامت بعد از یکسال": "تمدید اقامت نیازمند مدرک ثبت‌نام، بیمه، حساب بانکی و اثبات پیشرفت تحصیلی است."
}


def split_into_rows(items, row_size=2):
    return [items[i:i+row_size] for i in range(0, len(items), row_size)]

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    with open("users_log.txt", "a", encoding="utf-8") as f:
        f.write(f"{user.id} - {user.full_name}\n")

    await update.message.reply_text(
        "سلام 👋\nبه ربات مهاجرت به آلمان خوش آمدید!",
        reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True)
    )

async def handle_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    choice = update.message.text

    if choice == "📝 چک‌لیست مهاجرت":
        await update.message.reply_text("لطفا دسته‌بندی مورد نظر را انتخاب کنید:",
            reply_markup=ReplyKeyboardMarkup(CHECKLIST_MENU, resize_keyboard=True))
        return

    if choice == "🔙 بازگشت به منوی اصلی":
        await update.message.reply_text("بازگشت به منو",
            reply_markup=ReplyKeyboardMarkup(MAIN_MENU, resize_keyboard=True))
        return

    if choice == "🔙 بازگشت به چک‌لیست":
        await update.message.reply_text("بازگشت به چک‌لیست:",
            reply_markup=ReplyKeyboardMarkup(CHECKLIST_MENU, resize_keyboard=True))
        return

    if choice == "📋 مشاهده همه مراحل":
        all_subitems = sum(CHECKLIST_SUBITEMS.values(), [])
        all_rows = split_into_rows(all_subitems, 3)
        all_rows.append(["🔙 بازگشت به چک‌لیست"])
        await update.message.reply_text("تمام مراحل مهاجرت را انتخاب کنید:",
            reply_markup=ReplyKeyboardMarkup(all_rows, resize_keyboard=True))
        return

    if choice in CHECKLIST_SUBITEMS:
        sub_menu = split_into_rows(CHECKLIST_SUBITEMS[choice], 2) + [["🔙 بازگشت به چک‌لیست"]]
        await update.message.reply_text(f"زیرمجموعه‌های «{choice}»:",
            reply_markup=ReplyKeyboardMarkup(sub_menu, resize_keyboard=True))
        return

    if choice in CHECKLIST_CONTENTS:
        await update.message.reply_text(CHECKLIST_CONTENTS[choice])
        return

    main_responses = {
        "❓ سوالات پرتکرار": "پرسش‌های رایج درباره مهاجرت به آلمان...",
        "🔗 گروه‌های پرسش و پاسخ": "لینک گروه‌های مفید تلگرامی برای مهاجرت به آلمان...",
        "💼 خدمات مهاجرتی": "ما در زمینه اپلای، پذیرش، ویزا، ترجمه مدارک و مشاوره کمک می‌کنیم.",
        "📬 تماس با ما": "@behnamrmz"
    }

    if choice in main_responses:
        await update.message.reply_text(main_responses[choice])
    else:
        await update.message.reply_text("لطفاً از منوی موجود گزینه‌ای را انتخاب کنید.")

# 🟢 اجرای ربات
if __name__ == '__main__':
    app = ApplicationBuilder().token(os.getenv("BOT_TOKEN")).build()
    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_menu))
    app.run_polling()
